<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shanya's tracker :)</title>
  <style>
    :root{
      --bg:#03040a;
      --panel:#0b0d12;
      --muted:#9aa6b2;
      --text:#e6eef6;
      --accent:#7dd3fc;
      --accent-2:#c4b5fd;
      --ghost-bg: rgba(255,255,255,0.03);
      --btn-bg: linear-gradient(180deg,var(--accent),#14b8a6);
      --danger:#ff6b6b;
      --card:#040511;
      --glass: rgba(255,255,255,0.02);
    }
    /*Themes !!*/
    /*Light Mode (ew)*/
    body[data-theme="light"] {
        --bg: #f1f5f9; --panel: #ffffff; --card: #ffffff; --text: #0f172a; --muted: #64748b;
        --accent: #0ea5e9; --accent-2: #8b5cf6; --ghost-bg: rgba(0,0,0,0.03);
        --btn-bg: linear-gradient(180deg,var(--accent),#0d9488);
    }
    /* Christmas Theme */
    body[data-theme="christmas"] {
        --bg: #0c2a23; --panel: #103c31; --card: #0c342a; --text: #f1f5f9; --muted: #94a3b8;
        --accent: #ef4444; --accent-2: #f59e0b; --danger: #fbbf24;
        --btn-bg: linear-gradient(180deg, var(--accent), #dc2626);
    }
    /* Halloween Theme */
    body[data-theme="halloween"] {
        --bg: #110c1c; --panel: #1e1b2b; --card: #191624; --text: #f1f5f9; --muted: #a1a1aa;
        --accent: #f97316; --accent-2: #a855f7;
        --btn-bg: linear-gradient(180deg, #f97316, #ea580c);
    }
    /* Strawberry Theme */
    body[data-theme="strawberry"] {
        --bg: #2e0915; --panel: #421322; --card: #3b111e; --text: #fce7f3; --muted: #f472b6;
        --accent: #ec4899; --accent-2: #d946ef;
        --btn-bg: linear-gradient(180deg, #ec4899, #db2777);
    }
    /* Summer Theme */
    body[data-theme="summer"] {
        --bg: #03040a; --panel: #0b0d12; --card: #040511; --text: #e6eef6;
        --accent: #f59e0b; --accent-2: #14b8a6;
        --btn-bg: linear-gradient(180deg, #f59e0b, #d97706);
    }
    /* Blue Theme */
    body[data-theme="blue"] {
        --bg: #070912; --panel: #0f172a; --card: #0b1120; --text: #e2e8f0; --muted: #94a3b8;
        --accent: #38bdf8; --accent-2: #6366f1;
        --btn-bg: linear-gradient(180deg, #38bdf8, #0ea5e9);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: var(--bg);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:60px;
      transition: background .3s ease, color .3s ease;
    }

    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, color-mix(in srgb, var(--bg) 90%, transparent), color-mix(in srgb, var(--bg) 70%, transparent));
      border-bottom: 1px solid color-mix(in srgb, var(--text) 4%, transparent);
      backdrop-filter: blur(6px);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:1.5rem;letter-spacing:.4px}
    .grid{display:grid;gap:14px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .panel{background:var(--panel);border:1px solid color-mix(in srgb, var(--text) 4%, transparent);border-radius:12px;padding:14px}
    .card{background:var(--card);border:1px solid color-mix(in srgb, var(--text) 3%, transparent);border-radius:10px;padding:12px}
    .row{display:flex;gap:12px;align-items:center}
    .between{display:flex;justify-content:space-between;align-items:center}
    .muted{color:var(--muted)}
    button,input,select,textarea{font:inherit}
    .btn{
      background:var(--btn-bg); color: color-mix(in srgb, var(--bg) 85%, #000); border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .btn:hover{ transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.45); }
    .secondary{
      background:var(--ghost-bg); color:var(--text); border:1px solid color-mix(in srgb, var(--text) 6%, transparent); padding:8px 10px; border-radius:9px;
    }
    .secondary:hover{ background: color-mix(in srgb, var(--text) 4%, transparent); transform: translateY(-2px); }
    .ghost{
      background: linear-gradient(180deg, color-mix(in srgb, var(--text) 1%, transparent), color-mix(in srgb, var(--text) 2%, transparent));
      color:var(--text); border:1px solid color-mix(in srgb, var(--text) 4%, transparent); padding:8px 10px; border-radius:9px;
    }
    .ghost:hover{ transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.45); }
    .danger{ background: linear-gradient(180deg,var(--danger), #e55353); color:#120000; border-radius:10px; padding:8px 12px }
    .tiny{ font-size:.8rem; padding:6px 8px; border-radius:8px }
    label{font-size:.9rem;color:var(--muted)}
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{
      width:100%;background:transparent;border:1px solid color-mix(in srgb, var(--text) 4%, transparent);color:var(--text);
      border-radius:8px;padding:8px;font-family:inherit;
    }
    textarea{min-height:72px}
    .kpi{font-size:1.9rem;font-weight:800}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid color-mix(in srgb, var(--text) 4%, transparent);background:transparent;color:var(--text);font-size:.85rem}
    .progress{height:10px;background:color-mix(in srgb, var(--text) 2%, transparent);border-radius:999px;overflow:hidden;border:1px solid color-mix(in srgb, var(--text) 3%, transparent)}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid color-mix(in srgb, var(--text) 3%, transparent);cursor:pointer;background:transparent;color:var(--muted);transition:all .14s ease}
    .tab:hover{transform:translateY(-3px);color:var(--text)}
    .tab.active{background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 8%, transparent), color-mix(in srgb, var(--accent-2) 4%, transparent)); color:var(--text); border-color: color-mix(in srgb, var(--accent) 12%, transparent)}
    .section{display:none; opacity:0; transform:translateY(6px); transition: all .18s cubic-bezier(.2,.9,.3,1); }
    .section.active{display:block;opacity:1;transform:none}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
    .day{border:1px solid color-mix(in srgb, var(--text) 3%, transparent);border-radius:12px;min-height:92px;padding:8px;background:transparent;display:flex;flex-direction:column; transition: background .2s ease, border-color .2s ease;}
    .day .dnum{font-weight:700;color:var(--text)}
    .today{outline:2px solid color-mix(in srgb, var(--accent) 18%, transparent);box-shadow: inset 0 0 18px color-mix(in srgb, var(--accent) 2%, transparent);border-radius:12px}
    .event{margin-top:6px;font-size:.82rem;padding:6px;border-radius:8px;background:color-mix(in srgb, var(--text) 2%, transparent);border:1px solid color-mix(in srgb, var(--text) 2%, transparent); cursor:grab;}
    .event .when{font-size:.72rem;color:var(--muted);opacity:.85}
    .timer{font-size:2.6rem;font-weight:800;letter-spacing:1px}
    .footnote{font-size:.85rem;color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .chip{border:1px solid color-mix(in srgb, var(--text) 3%, transparent);background:transparent;border-radius:999px;padding:6px 10px;display:flex;justify-content:space-between;align-items:center}
    .small{font-size:.85rem}
    .link{color:var(--accent)}
    .modal-back{position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5));display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--panel);border-radius:12px;padding:18px;max-width:520px;border:1px solid color-mix(in srgb, var(--text) 4%, transparent)}
    .btn-icon{background:transparent;border:1px solid color-mix(in srgb, var(--text) 4%, transparent);padding:6px;border-radius:8px;color:var(--muted)}
    .btn-icon:hover{color:var(--text);transform:translateY(-3px)}
    #next-test-box .chip { padding:10px; }
    .hw-importance { background:transparent; color:var(--muted); border:1px solid color-mix(in srgb, var(--text) 4%, transparent); padding:6px; border-radius:8px; }
    .event.dragging { opacity: 0.5; border: 1px dashed var(--accent); cursor: grabbing; }
    .day.drag-over { background: var(--glass); border-color: var(--accent); }
    #delete-zone { display: none; padding: 20px; text-align: center; border: 2px dashed var(--danger); margin-top: 10px; background: color-mix(in srgb, var(--danger) 5%, transparent); color: var(--danger); border-radius:12px; transition: background .2s ease; }
    #delete-zone.drag-over { background: color-mix(in srgb, var(--danger) 15%, transparent); }
    body.dragging-active #delete-zone { display: block; }
    .task-item { display: flex; align-items: center; gap: 12px; }
    .task-item input[type="checkbox"] { width: auto; }
    .task-item label { text-decoration: none; transition: all .2s ease; flex-grow: 1; }
    .task-item input:checked + label { text-decoration: line-through; opacity: 0.6; }
  </style>
</head>
<body>
  <header>
    <div class="wrap between" style="gap:12px">
      <div style="display:flex;align-items:center;gap:14px">
        <h1>Shanya's tracker :)</h1>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div id="tabs" class="tabs"></div>
        <button id="settingsBtn" class="btn-icon" title="Settings (click)">‚öôÔ∏è</button>
        <button id="streak-pill" class="pill" title="Click for streak details">üî• <strong id="streak-count">0</strong> days</button>
        <button class="secondary" id="exportBtn" title="Export your data as JSON">Export</button>
        <label class="pill" style="cursor:pointer">Import
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </label>
        <div id="auth-container"></div>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="gap:18px;margin-top:14px">

    <section id="sec-dashboard" class="section active">
        <div class="panel" style="margin-bottom:18px">
            <div class="between" style="margin-bottom:12px">
              <h3>Reminders</h3>
              <div class="row">
                <input id="reminderText" type="text" placeholder="Quick reminder..." style="width:320px"/>
                <button id="addReminder" class="secondary tiny">Add</button>
              </div>
            </div>
            <div id="reminders-list" class="list"></div>
        </div>

      <div class="grid cards">
        <div class="card">
          <div class="between"><h3>Today's Study</h3><span class="pill" id="today-date"></span></div>
          <div style="height:12px"></div>
          <div class="kpi" id="today-mins">0m</div>
        </div>
        <div class="card">
          <div class="between"><h3>This Week</h3><span class="pill" id="week-range"></span></div>
          <div style="height:12px"></div>
          <div class="kpi" id="week-mins">0m</div>
        </div>
        <div class="card">
          <div class="between"><h3>Next Up</h3><span class="pill" id="next-test-pill">‚Äî</span></div>
          <div style="height:12px"></div>
          <div id="next-test-box"></div>
        </div>
      </div>

      <div id="dashboard-goals" class="panel" style="margin-top:6px"></div>

      <div class="panel" style="margin-top:6px">
        <div class="between"><h3>Subjects</h3>
          <button id="addSubjectBtn" class="ghost">Ôºã Add Subject</button>
        </div>
        <div id="subjects-list" class="grid cards"></div>
      </div>
    </section>

    <section id="sec-graph" class="section">
      <div class="panel">
        <div class="between">
            <h3>Study by Subject</h3>
            <div id="graph-filters" class="tabs">
                <button class="tab active" data-period="all">All Time</button>
                <button class="tab" data-period="month">This Month</button>
                <button class="tab" data-period="week">This Week</button>
            </div>
        </div>
        <div id="graph-container" style="height: 300px; overflow-y: auto; position: relative; margin-top:12px;">
          <canvas id="graphCanvas"></canvas>
        </div>
      </div>
    </section>
    
    <section id="sec-dailytasks" class="section">
        <div class="panel">
            <div class="between">
                <h3>Daily</h3>
                <button id="addDailyTaskBtn" class="ghost">Ôºã Add Task</button>
            </div>
            <p class="muted small" style="margin-top:4px; margin-bottom: 12px;">Tasks reset every day.</p>
            <div id="daily-tasks-list" class="list"></div>
        </div>
    </section>

    <section id="sec-timer" class="section">
      <div class="panel">
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;align-items:start">
          <div class="card">
            <label for="timerSubject">Subject</label>
            <select id="timerSubject"></select>
            <div class="timer" id="timerDisplay" style="margin-top:10px">00:00:00</div>
            <div class="row" style="margin-top:10px;gap:8px">
              <button id="startBtn" class="btn">Start</button>
              <button class="secondary" id="pauseBtn">Pause</button>
              <button class="secondary" id="resumeBtn">Resume</button>
              <button class="danger" id="stopBtn">Log</button>
            </div>
            <div style="height:12px"></div>
            <div class="footnote">Logging saves the session and updates your streak.</div>
          </div>
          <div class="card">
            <h3>Quick Log</h3>
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
              <div>
                <label>Minutes</label>
                <input type="number" id="quickMinutes" min="1" value="25" />
              </div>
              <div>
                <label>Subject</label>
                <select id="quickSubject"></select>
              </div>
            </div>
            <div class="row" style="margin-top:10px"><button id="quickAdd" class="btn">Add</button></div>
          </div>
          <div class="card">
            <h3>Recent Sessions</h3>
            <div id="recent-sessions" class="list"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="sec-calendar" class="section">
      <div class="panel">
        <div class="between">
          <h3>Calendar</h3>
          <div class="row">
            <button class="secondary" id="prevMonth">‚óÄ</button>
            <div class="pill" id="monthLabel"></div>
            <button class="secondary" id="nextMonth">‚ñ∂</button>
          </div>
        </div>
        <div class="cal-head muted small">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calendar" class="calendar" style="margin-top:8px"></div>
        <div id="delete-zone">
          üóëÔ∏è Drop here to delete
        </div>
      </div>

      <div class="panel" style="margin-top:10px">
        <h3>Add Calendar Item</h3>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
          <div><label>Title</label><input id="testTitle" type="text" placeholder="Chapter 3 Quiz"/></div>
          <div><label>Subject</label><select id="testSubject"></select></div>
          <div><label>Date</label><input id="testDate" type="date" /></div>
          <div><label>Time</label><input id="testTime" type="time" /></div>
          <div>
            <label>Type</label>
            <select id="testType">
              <option value="test">Test</option>
              <option value="activity">Activity</option>
              <option value="project">Project</option>
            </select>
          </div>
          <div><label>Milestones (for Projects)</label><textarea id="projectMilestones" placeholder="YYYY-MM-DD|Draft due..."></textarea></div>
        </div>
        <div class="row" style="margin-top:10px"><button id="addTestBtn" class="btn">Add</button></div>
        <div class="list" id="upcoming-tests" style="margin-top:12px"></div>
      </div>
    </section>

    <section id="sec-homework" class="section">
      <div class="panel">
        <h3>Homework</h3>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px">
          <div><label>Title</label><input id="hwTitle" type="text" placeholder="Read chapter 4"/></div>
          <div><label>Subject</label><select id="hwSubject"></select></div>
          <div><label>Due Date</label><input id="hwDate" type="date" /></div>
          <div><label>Notes</label><input id="hwNotes" type="text" /></div>
        </div>
        <div class="row" style="margin-top:10px"><button id="addHwBtn" class="btn">Add Homework</button></div>
        <div class="list" id="hwList" style="margin-top:12px"></div>
      </div>
    </section>
  </main>

  <div id="settingsModal" style="display:none">
    <div class="modal-back" id="settingsBack">
      <div class="modal">
        <div class="between"><h3>Settings</h3><button id="closeSettings" class="secondary tiny">Close</button></div>
        <div style="margin-top:12px; display: flex; flex-direction: column; gap: 15px;">
            <div class="row between">
                <div>
                    <div>Theme</div>
                    <div class="muted small">Change the application's color scheme.</div>
                </div>
                <select id="themeSelector" class="secondary tiny">
                    <option value="original">Original</option>
                    <option value="light">Light Mode</option>
                    <option value="christmas">Christmas</option>
                    <option value="halloween">Halloween</option>
                    <option value="strawberry">Strawberry</option>
                    <option value="summer">Summer</option>
                    <option value="blue">Blue</option>
                </select>
            </div>
          <div class="row between">
            <div>
              <div>Notifications</div>
              <div class="muted small">Allow browser notifications for reminders (30 minutes before).</div>
            </div>
            <button id="notifBtn" class="secondary tiny">Request Permission</button>
          </div>
          <div class="row between">
            <div>
              <div>Reset Site</div>
              <div class="muted small">Restore default subjects and clear all your data.</div>
            </div>
            <button id="resetBtn" class="danger tiny">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="streakModal" style="display:none">
    <div class="modal-back" id="modalBack">
      <div class="modal" role="dialog" aria-modal="true">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:30px">üî•</div>
          <div>
            <strong id="modalStreakCount">0</strong>
            <div class="muted">day streak</div>
          </div>
        </div>
        <p style="margin-top:12px" id="streakMessage">Nice work ‚Äî keep it up! Small consistent steps win.</p>
        <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeModal" class="secondary">Close</button></div>
      </div>
    </div>
  </div>

<script type="module">
  // Firebase Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ---------- Firebase & Auth Setup ----------
  let db, auth, userId;
  let appData = {}; // In-memory data store

  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
  // setLogLevel('debug'); // Uncomment for detailed logs

  function getInitialState() {
    return {
        subjects: [], sessions: [], tests: [],
        streak: { count: 0, last: "" }, reminders: [],
        homework: [], recentIds: [],
        dailyTasks: { lastReset: "", items: [] },
        theme: 'original'
    };
  }

  async function saveData() {
    if (!userId) return;
    try {
        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data`, 'tracker');
        await setDoc(userDocRef, appData);
    } catch (error) {
        console.error("Error saving data:", error);
    }
  }

  async function loadData() {
    if (!userId) return;
    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data`, 'tracker');
    try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
            appData = { ...getInitialState(), ...docSnap.data() };
        } else {
            appData = getInitialState();
            appData.subjects = [
                {id: uuid(), name: 'Math', color: '#7dd3fc', weeklyGoal: 300},
                {id: uuid(), name: 'Biology', color: '#c4b5fd', weeklyGoal: 240},
            ];
            await saveData();
        }
        applyTheme(appData.theme || 'original');
        refreshAll();
    } catch (error) {
        console.error("Error loading data:", error);
        appData = getInitialState();
        refreshAll();
    }
  }

  onAuthStateChanged(auth, async (user) => {
    const authContainer = document.getElementById('auth-container');
    if (user) {
        userId = user.uid;
        authContainer.innerHTML = `<button id="logoutBtn" class="secondary tiny">Logout</button>`;
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        await loadData();
    } else {
        userId = null;
        authContainer.innerHTML = `<button id="loginBtn" class="btn">Login / Register</button>`;
        document.getElementById('loginBtn').onclick = async () => {
             if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
             } else {
                await signInAnonymously(auth);
             }
        };
        appData = getInitialState();
        refreshAll();
    }
  });

  // ---------- Data Management Layer (replaces localStorage) ----------
  const dataManager = {
    set subjects(v){ appData.subjects = v; saveData(); refreshAll(); },
    get subjects(){ return appData.subjects || []; },
    set sessions(v){ appData.sessions = v; saveData(); refreshAll(); },
    get sessions(){ return appData.sessions || []; },
    set tests(v){ appData.tests = v; saveData(); refreshAll(); },
    get tests(){ return appData.tests || []; },
    set streak(v){ appData.streak = v; saveData(); refreshAll(); },
    get streak(){ return appData.streak || {count:0,last:""}; },
    set reminders(v){ appData.reminders = v; saveData(); renderReminders(); },
    get reminders(){ return appData.reminders || []; },
    set homework(v){ appData.homework = v; saveData(); refreshAll(); },
    get homework(){ return appData.homework || []; },
    set recentIds(v){ appData.recentIds = v; saveData(); renderRecent(); },
    get recentIds(){ return appData.recentIds || []; },
    set dailyTasks(v){ appData.dailyTasks = v; saveData(); renderDailyTasks(); },
    get dailyTasks(){ return appData.dailyTasks || {lastReset:"",items:[]}; },
    set theme(v){ appData.theme = v; saveData(); applyTheme(v); },
    get theme(){ return appData.theme || 'original'; },
  };

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const pad = n => String(n).padStart(2,'0');
  const todayISO = () => new Date().toISOString().slice(0,10);
  const toISODate = (d)=> new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const startOfWeek = (d)=> { const x=new Date(d); const day=x.getDay(); x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; };
  const endOfWeek = d=> {const x=new Date(startOfWeek(d)); x.setDate(x.getDate()+6); return x; };
  const startOfMonth = d => { const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; };
  const endOfMonth = d => { const x=new Date(d.getFullYear(), d.getMonth()+1, 0); return x; };
  const formatHM = m => `${Math.floor(m/60)}h ${m%60}m`;
  function uuid(){return Math.random().toString(36).slice(2,9)}

  let calMonth = new Date();

  // ---------- Up Next ----------
  const IMPORTANCE_MULT = { auto:1, low:0.7, medium:1, high:1.6, critical:2.5 };
  const IMPORTANCE_COL = { auto:'var(--muted)', low:'#94a3b8', medium:'var(--accent)', high:'#fbbf24', critical:'#fb7185' };

  function getMinutesThisWeekForSubject(subjectId){
    const a = startOfWeek(new Date()); a.setHours(0,0,0,0);
    const b = endOfWeek(new Date()); b.setHours(23,59,59,999);
    return dataManager.sessions
      .filter(s => s.subjectId === subjectId && new Date(s.at) >= a && new Date(s.at) <= b)
      .reduce((sum, rec) => sum + rec.minutes, 0);
  }

  function scoreHomeworkItem(hw){
    if(!hw.due) return 20;
    const dueDate = new Date(hw.due + 'T23:59:59');
    const today = new Date(); today.setHours(0,0,0,0);
    const days = Math.round((dueDate - today) / 86400000);
    if(days < 0) return 1200; if(days === 0) return 1000; if(days === 1) return 800;
    if(days <= 3) return 500; if(days <= 7) return 240; return 50;
  }

  function scoreTestItem(t){
    if(!t.date) return 30;
    const testDate = new Date(t.date + 'T' + (t.time||'23:59:59'));
    const days = Math.floor((testDate - Date.now()) / 86400000);
    if(days < 0) return 1000; if(days === 0) return 800; if(days === 1) return 650;
    if(days <= 7) return 300; return 60;
  }

  function scoreProjectMilestone(test, msObj){
    const dueDate = new Date(msObj.date + 'T23:59:59');
    const today = new Date(); today.setHours(0,0,0,0);
    const days = Math.round((dueDate - today) / 86400000);
    if(days < 0) return 1100; if(days === 0) return 950; if(days === 1) return 750;
    if(days <= 7) return 500; return 80;
  }

  function computeUpNextCandidates(){
    const candidates = [];
    (dataManager.homework || []).filter(h => !h.done).forEach(hw=>{
      const base = scoreHomeworkItem(hw);
      const subjDeficitScore = (()=>{
        if(!hw.subjectId) return 0;
        const sub = dataManager.subjects.find(s=>s.id===hw.subjectId); if(!sub || !sub.weeklyGoal) return 0;
        const deficit = Math.max(0, (sub.weeklyGoal - getMinutesThisWeekForSubject(sub.id)));
        return Math.min(300, Math.round(300 * (deficit / (sub.weeklyGoal || 1))));
      })();
      const impKey = hw.importance || 'auto';
      candidates.push({ id: hw.id, type: 'homework', score: (base + subjDeficitScore) * (IMPORTANCE_MULT[impKey] || 1), label: hw.title, due: hw.due || '', importance: impKey, subjectId: hw.subjectId, meta: hw });
    });

    (dataManager.tests || []).forEach(t=>{
      const isProject = t.type === 'project' && Array.isArray(t.milestones) && t.milestones.length > 0;
      if (isProject) {
        t.milestones.forEach(ms=>{
            const base = scoreProjectMilestone(t, ms);
            const subjScore = t.subjectId ? Math.min(200, Math.round(getMinutesThisWeekForSubject(t.subjectId))) : 0;
            candidates.push({ id: t.id + '::' + ms.date, type: 'milestone', score: (base + (200 - subjScore)), label: `${t.title} ‚Äî ${ms.label}`, due: ms.date, importance: 'auto', subjectId: t.subjectId, meta: { test: t, milestone: ms } });
        });
      } else {
        const base = scoreTestItem(t);
        const subjDeficitScore = t.subjectId ? Math.min(300, Math.round(300 * Math.max(0, ( ( (dataManager.subjects.find(s=>s.id===t.subjectId)||{}).weeklyGoal || 0) - getMinutesThisWeekForSubject(t.subjectId) ) / ( (dataManager.subjects.find(s=>s.id===t.subjectId)||{}).weeklyGoal || 1) ))) : 0;
        candidates.push({ id: t.id, type: 'test', score: (base + subjDeficitScore) * (t.type === 'activity' ? 0.2 : 1.2), label: t.title, due: t.date || '', importance: 'auto', subjectId: t.subjectId, meta: t });
      }
    });

    (dataManager.subjects || []).forEach(s=>{
      const deficit = Math.max(0, (s.weeklyGoal || 0) - getMinutesThisWeekForSubject(s.id));
      if(deficit > Math.max(30, (s.weeklyGoal || 0) * 0.25)){
        candidates.push({ id: 'catchup::' + s.id, type: 'catchup', score: Math.min(200, deficit), label: `Study ${s.name}`, due: '', importance: 'auto', subjectId: s.id, meta: { deficit } });
      }
    });
    return candidates.sort((a,b)=>b.score - a.score);
  }

  function getUpNextList() {
    const candidates = computeUpNextCandidates();
    let finalList = []; const addedIds = new Set();
    const homeworks = candidates.filter(c => c.type === 'homework');
    const projects = candidates.filter(c => c.type === 'milestone');
    const studies = candidates.filter(c => ['test', 'catchup'].includes(c.type));
    
    if (projects.length > 0) { finalList.push(projects[0]); addedIds.add(projects[0].id); }
    const topHw = homeworks.find(h => !addedIds.has(h.id));
    if (topHw) { finalList.push(topHw); addedIds.add(topHw.id); }
    if (!finalList.some(item => projects.includes(item) || studies.includes(item))) {
        const topStudy = studies.find(s => !addedIds.has(s.id));
        if (topStudy) { finalList.push(topStudy); addedIds.add(topStudy.id); }
    }
    const remaining = candidates.filter(c => !addedIds.has(c.id));
    while (finalList.length < 3 && remaining.length > 0) {
        finalList.push(remaining.shift());
    }
    return finalList.sort((a,b) => b.score - a.score);
  }

  function renderUpNext(){
    const list = getUpNextList();
    const box = $('#next-test-box'); box.innerHTML = '';
    if(list.length === 0){
      box.innerHTML = '<div class="muted">You\'re all caught up!</div>';
      $('#next-test-pill').textContent = '‚Äî'; return;
    }
    $('#next-test-pill').textContent = list[0].due || 'Soon';
    list.forEach(item=>{
      const sub = dataManager.subjects.find(s=>s.id===item.subjectId);
      const color = sub ? sub.color : IMPORTANCE_COL[item.importance];
      const el = document.createElement('div'); el.className = 'chip'; el.style.marginBottom = '8px';
      el.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
                        <div style="width:10px;height:10px;border-radius:3px;background:${color}"></div>
                        <div>
                          <div><strong>${item.label}</strong>${sub?` ‚Äî <span style="color:${sub.color}">${sub.name}</span>`:''}</div>
                          <div class="muted small">${item.type}${item.due ? ` ‚Ä¢ ${item.due}` : ''}</div>
                        </div>
                      </div>
                      <button title="Mark as done" class="secondary tiny" data-action>‚úî</button>`;
      el.querySelector('[data-action]').onclick = ()=>{
        if(item.type === 'homework'){ dataManager.homework = dataManager.homework.map(h=>h.id===item.id?{...h, done:true}:h); }
        else if(item.type === 'milestone'){
          const t = dataManager.tests.find(x=>x.id===item.meta.test.id); if(t){ t.milestones = t.milestones.filter(m=> m.date!==item.meta.milestone.date || m.label!==item.meta.milestone.label); dataManager.tests = dataManager.tests; }
        } else if(item.type === 'test'){ if(confirm('Delete this item?')){ dataManager.tests = dataManager.tests.filter(x=>x.id!==item.id); }}
        else if(item.type === 'catchup'){ alert('Log time for this subject to clear this suggestion.'); }
        refreshAll();
      };
      box.appendChild(el);
    });
  }

  // ---------- Tabs ----------
  const sections = [ { id:'dashboard', label:'Dashboard' }, { id:'graph', label:'Graph' }, { id:'dailytasks', label:'Daily Tasks'}, { id:'timer', label:'Timer' }, { id:'calendar', label:'Calendar' }, { id:'homework', label:'Homework' }, ];
  const tabs = $('#tabs');
  sections.forEach((s,i)=>{
    const el = document.createElement('button'); el.className = 'tab' + (i===0?' active':'');
    el.textContent = s.label; el.dataset.target = s.id;
    el.onclick = ()=>{
      $$('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
      $$('.section').forEach(sec=>sec.classList.remove('active'));
      $('#sec-'+s.id).classList.add('active');
      if(s.id==='calendar') renderCalendar();
      if(s.id==='graph') renderGraph();
      if(s.id==='homework') renderHomeworkList();
      if(s.id==='dailytasks') renderDailyTasks();
    };
    tabs.appendChild(el);
  });

  $('#settingsBtn').onclick = ()=>{ $('#settingsModal').style.display='block'; $('#settingsBack').style.display='flex'; };
  $('#closeSettings').onclick = ()=>{ $('#settingsModal').style.display='none'; $('#settingsBack').style.display='none'; };
  $('#settingsBack').onclick = (e)=>{ if(e.target.id==='settingsBack') { $('#settingsModal').style.display='none'; } }

  // ---------- Subjects UI ----------
  function renderSubjects(){
    const list = $('#subjects-list'); list.innerHTML='';
    dataManager.subjects.forEach(sub=>{
      const total = dataManager.sessions.filter(x=>x.subjectId===sub.id).reduce((a,b)=>a+b.minutes,0);
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div class="between">
          <div class="row"><div style="width:10px;height:10px;border-radius:3px;background:${sub.color};margin-right:8px"></div><strong>${sub.name}</strong></div>
          <div class="row"><button class="secondary tiny" data-edit>‚úé</button><button class="secondary tiny" data-del>üóë</button></div></div>
        <div style="height:8px"></div><div class="muted small">Total: ${formatHM(total)}</div><div class="muted small">Weekly goal: ${formatHM(sub.weeklyGoal||0)}</div>`;
      card.querySelector('[data-del]').onclick = ()=>{ if(confirm(`Delete "${sub.name}"?`)){ dataManager.subjects = dataManager.subjects.filter(s=>s.id!==sub.id); dataManager.sessions = dataManager.sessions.map(s=> s.subjectId===sub.id ? {...s, subjectId:null} : s); } };
      card.querySelector('[data-edit]').onclick = ()=>{
        const name = prompt('Subject name', sub.name) || sub.name; const color = prompt('Color', sub.color) || sub.color;
        const mins = parseInt(prompt('Weekly goal (minutes)', sub.weeklyGoal||0) || sub.weeklyGoal||0);
        dataManager.subjects = dataManager.subjects.map(s=> s.id===sub.id? {...s,name,color,weeklyGoal:mins}:s);
      };
      list.appendChild(card);
    });
    const opts = dataManager.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    $('#timerSubject').innerHTML = opts; $('#quickSubject').innerHTML = opts;
    $('#testSubject').innerHTML = '<option value="">‚Äî</option>' + opts; $('#hwSubject').innerHTML = '<option value="">‚Äî</option>' + opts;
  }
  $('#addSubjectBtn').onclick = ()=>{
    const name = prompt('New subject name'); if(!name) return;
    const color = prompt('Color', '#7dd3fc') || '#7dd3fc'; const weeklyGoal = parseInt(prompt('Weekly goal (minutes)', '300')||'300');
    dataManager.subjects = [...dataManager.subjects, {id:uuid(), name, color, weeklyGoal}];
  };

  // ---------- Timer ----------
  let timer = { running:false, start:0, elapsed:0, tick:null };
  function updateTimerUI(){ const s = Math.floor((timer.running ? (Date.now()-timer.start + timer.elapsed) : timer.elapsed)/1000); $('#timerDisplay').textContent = `${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`; }
  function start(){ if(timer.running) return; timer.running=true; timer.start=Date.now(); timer.tick=setInterval(updateTimerUI,250); }
  function pause(){ if(!timer.running) return; timer.elapsed += Date.now()-timer.start; timer.running=false; clearInterval(timer.tick); updateTimerUI(); }
  function resetTimer(){ timer={running:false,start:0,elapsed:0,tick:null}; updateTimerUI(); }
  $('#startBtn').onclick = start; $('#pauseBtn').onclick = pause; $('#resumeBtn').onclick = start;
  $('#stopBtn').onclick = ()=>{ if(timer.running) pause(); logSession(Math.max(1, Math.round(timer.elapsed/60000)), $('#timerSubject').value||null); resetTimer(); };
  $('#quickAdd').onclick = ()=>{ logSession(Math.max(1, parseInt($('#quickMinutes').value||'0')), $('#quickSubject').value||null) };

  function logSession(minutes, subjectId){
    const now = new Date();
    dataManager.sessions = [{ id: uuid(), subjectId, minutes, at: now.toISOString() }, ...dataManager.sessions].slice(0, 2000);
    const ids = dataManager.recentIds || []; ids.unshift(dataManager.sessions[0].id); dataManager.recentIds = ids.slice(0,5);
    updateStreakOnStudy(now);
  }

  function updateStreakOnStudy(now){
    const last = dataManager.streak.last ? new Date(dataManager.streak.last) : null; const today = toISODate(now); if(!last){ dataManager.streak = {count:1, last:now.toISOString()}; return }
    const lastDate = toISODate(last); if(lastDate === today){ return }
    const yest = toISODate(new Date(now.getFullYear(),now.getMonth(),now.getDate()-1));
    dataManager.streak = {count: (lastDate===yest) ? dataManager.streak.count+1 : 1, last: now.toISOString()};
  }

  function renderRecent(){
    const box = $('#recent-sessions'); box.innerHTML=''; if(!dataManager.recentIds.length){ box.innerHTML = '<div class="muted">No recent sessions.</div>'; return; }
    dataManager.recentIds.forEach(id=>{
      const s = dataManager.sessions.find(x=>x.id===id); if(!s) return;
      const sub = dataManager.subjects.find(x=>x.id===s.subjectId);
      const item = document.createElement('div'); item.className='row between chip';

      item.innerHTML = `
        <div class="row" data-session-info>
            <strong data-subject-name>${sub ? sub.name : '(none)'}</strong>
            <span style="margin-left: 8px;">‚Ä¢ ${formatHM(s.minutes)}</span>
        </div>
        <div class="row">
            <div class="muted small">${new Date(s.at).toLocaleDateString()}</div>
            <button class="secondary tiny" data-edit title="Edit subject">‚úé</button>
            <button class="secondary tiny" data-del title="Delete session">üóëÔ∏è</button>
        </div>`;
      
      item.querySelector('[data-del]').onclick = () => {
        if (confirm('Are you sure you want to delete this session? This will permanently remove the logged time and cannot be undone.')) {
          dataManager.sessions = dataManager.sessions.filter(x => x.id !== s.id);
          dataManager.recentIds = dataManager.recentIds.filter(x => x.id !== s.id);
        }
      };

      item.querySelector('[data-edit]').onclick = (e) => {
        const subjectNameEl = item.querySelector('[data-subject-name]');
        e.target.style.display = 'none';

        const select = document.createElement('select');
        select.className = 'secondary tiny';
        const subjectOptions = dataManager.subjects.map(subj => `<option value="${subj.id}" ${subj.id === s.subjectId ? 'selected' : ''}>${subj.name}</option>`).join('');
        select.innerHTML = `<option value="">(none)</option>${subjectOptions}`;
        
        subjectNameEl.replaceWith(select);
        select.focus();

        select.onchange = () => {
            const newSubjectId = select.value || null;
            dataManager.sessions = dataManager.sessions.map(session => session.id === s.id ? { ...session, subjectId: newSubjectId } : session);
        };

        select.onblur = () => {
            renderRecent();
        };
      };

      box.appendChild(item);
    });
  }

  // ---------- KPIs / Dashboard ----------
  function renderKPIs(){
    $('#today-mins').textContent = formatHM(dataManager.sessions.filter(s=>s.at.slice(0,10)===todayISO()).reduce((a,b)=>a+b.minutes,0));
    $('#today-date').textContent = new Date().toDateString();
    const now=new Date(), a=startOfWeek(now), b=endOfWeek(now);
    $('#week-range').textContent = `${a.toLocaleDateString(undefined,{month:'short',day:'numeric'})} ‚Äì ${b.toLocaleDateString(undefined,{month:'short',day:'numeric'})}`;
    $('#week-mins').textContent = formatHM(dataManager.sessions.filter(s=>{ const d=new Date(s.at); return d>=a && d<=b; }).reduce((x,y)=>x+y.minutes,0));
    $('#streak-count').textContent = dataManager.streak.count||0; $('#modalStreakCount').textContent = dataManager.streak.count||0;
    const c = dataManager.streak.count||0; $('#streakMessage').textContent = c<=1 ? "Start small, build a habit." : c<7 ? `${c} days in a row, keep it up!` : `üî• ${c} days strong!`;
  }
  $('#streak-pill').onclick = ()=>{ $('#streakModal').style.display='block'; $('#modalBack').style.display='flex'; };
  $('#closeModal').onclick = ()=>{ $('#streakModal').style.display='none'; $('#modalBack').style.display='none'; };
  document.addEventListener('click', (e)=>{ if(e.target.id==='modalBack'){ $('#streakModal').style.display='none'; } });

  function renderGoalsDashboard(){
    const container = $('#dashboard-goals'); container.innerHTML='';
    const a=startOfWeek(new Date()), b=endOfWeek(new Date());
    dataManager.subjects.forEach(sub=>{
      const mins = dataManager.sessions.filter(s=> s.subjectId===sub.id && new Date(s.at)>=a && new Date(s.at)<=b).reduce((p,c)=>p+c.minutes,0);
      const goal = sub.weeklyGoal||0; const pct = goal? Math.min(100, Math.round(100*mins/goal)) : 0;
      const card=document.createElement('div'); card.className='card'; card.style.marginBottom='8px';
      card.innerHTML=`<div class="between"><strong>${sub.name}</strong><span class="muted small">${formatHM(mins)} / ${formatHM(goal)}</span></div><div class="progress" style="margin-top:8px"><div style="width:${pct}%"></div></div>`;
      container.appendChild(card);
    });
  }

  // ---------- Calendar & D&D ----------
  let draggedItem = null;
  function handleDragStart(e) { draggedItem = { id: e.target.dataset.eventId, type: e.target.dataset.eventType, milestoneDate: e.target.dataset.milestoneDate, milestoneLabel: e.target.dataset.milestoneLabel }; e.dataTransfer.setData('text/plain', e.target.dataset.eventId); setTimeout(() => e.target.classList.add('dragging'), 0); document.body.classList.add('dragging-active'); }
  function handleDragEnd(e) { document.body.classList.remove('dragging-active'); draggedItem = null; $$('.dragging').forEach(d => d.classList.remove('dragging')); $$('.drag-over').forEach(d => d.classList.remove('drag-over')); }
  function handleDragOver(e) { e.preventDefault(); }
  function handleDragEnter(e) { e.target.closest('.day, #delete-zone')?.classList.add('drag-over'); }
  function handleDragLeave(e) { e.target.closest('.day, #delete-zone')?.classList.remove('drag-over'); }
  function handleDropOnDay(e) {
      e.preventDefault(); const day = e.target.closest('.day'); if (!day || !draggedItem) return;
      const newDate = day.dataset.date, tests = dataManager.tests, item = tests.find(t => t.id === draggedItem.id);
      if (item) { if (draggedItem.type === 'milestone') { const ms = item.milestones.find(m => m.date === draggedItem.milestoneDate && m.label === draggedItem.milestoneLabel); if (ms) ms.date = newDate; } else { item.date = newDate; } dataManager.tests = tests; }
      day.classList.remove('drag-over');
  }
  function handleDropOnDelete(e) {
      e.preventDefault(); if (!draggedItem || !confirm('Delete this item?')) return; let tests = dataManager.tests;
      if (draggedItem.type === 'milestone') { const item = tests.find(t => t.id === draggedItem.id); if (item) item.milestones = item.milestones.filter(m => !(m.date === draggedItem.milestoneDate && m.label === draggedItem.milestoneLabel)); }
      else { tests = tests.filter(t => t.id !== draggedItem.id); } dataManager.tests = tests;
      $('#delete-zone').classList.remove('drag-over');
  }
  function parseMilestones(txt){ if(!txt) return []; return txt.split(',').map(s=>{ const p=s.split('|').map(x=>x.trim()); return { date: p[0]||'', label: p[1]||'Milestone' }; }).filter(x=>x.date); }
  function renderCalendar(){
    $('#monthLabel').textContent = calMonth.toLocaleString(undefined,{month:'long',year:'numeric'});
    const grid = $('#calendar'); grid.innerHTML=''; const first = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1);
    const start = new Date(first); start.setDate(1 - first.getDay()); const today = todayISO();
    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i); const dateISO = toISODate(d);
      const cell = document.createElement('div'); cell.className='day' + (dateISO===today? ' today':'');
      if(d.getMonth()!==calMonth.getMonth()) cell.style.opacity=.45;
      cell.innerHTML = `<div class="between"><div class="dnum">${d.getDate()}</div><button class="ghost tiny" data-add title="Add item">Ôºã</button></div>`;
      cell.querySelector('[data-add]').onclick = ()=>{ $('#testDate').value = toISODate(d); $$('.tab').forEach(t=>t.classList.remove('active')); $$('.tab').find(t=>t.dataset.target==='calendar')?.classList.add('active'); $$('.section').forEach(s=>s.classList.remove('active')); $('#sec-calendar').classList.add('active'); };
      cell.dataset.date = dateISO; cell.addEventListener('dragover', handleDragOver); cell.addEventListener('dragenter', handleDragEnter); cell.addEventListener('dragleave', handleDragLeave); cell.addEventListener('drop', handleDropOnDay);
      dataManager.tests.forEach(t=>{
        const sub = dataManager.subjects.find(s=>s.id===t.subjectId);
        if(t.type==='project' && Array.isArray(t.milestones)){
          t.milestones.forEach(ms=>{
            if(ms.date===dateISO){
              const ev = document.createElement('div'); ev.className='event'; ev.innerHTML = `<div><strong>${t.title} ‚Ä¢ ${ms.label}</strong>${sub?` ‚Äî <span style="color:${sub.color}">${sub.name}</span>`:''}</div>`;
              ev.draggable = true; ev.dataset.eventId = t.id; ev.dataset.eventType = 'milestone'; ev.dataset.milestoneDate = ms.date; ev.dataset.milestoneLabel = ms.label;
              ev.addEventListener('dragstart', handleDragStart); ev.addEventListener('dragend', handleDragEnd); cell.appendChild(ev);
            }
          })
        }
        if(t.date===dateISO && t.type !== 'project'){
          const ev = document.createElement('div'); ev.className='event';
          ev.innerHTML = `<div><strong>${t.title}</strong><span class="muted"> [${t.type.toUpperCase()}]</span>${sub?` ‚Äî <span style="color:${sub.color}">${sub.name}</span>`:''}</div><div class="when">${t.time||'All day'}</div>`;
          ev.draggable = true; ev.dataset.eventId = t.id; ev.dataset.eventType = 'test';
          ev.addEventListener('dragstart', handleDragStart); ev.addEventListener('dragend', handleDragEnd); cell.appendChild(ev);
        }
      });
      grid.appendChild(cell);
    }
  }
  $('#prevMonth').onclick=()=>{ calMonth.setMonth(calMonth.getMonth()-1); renderCalendar() };
  $('#nextMonth').onclick=()=>{ calMonth.setMonth(calMonth.getMonth()+1); renderCalendar() };
  $('#addTestBtn').onclick=()=>{
    const title=$('#testTitle').value.trim(); if(!title){return alert('Title is required.')} const date=$('#testDate').value; if(!date){return alert('Date is required.')}
    dataManager.tests=[{id:uuid(), title, subjectId:$('#testSubject').value||null, date, time:$('#testTime').value||'', type:$('#testType').value||'test', milestones: parseMilestones($('#projectMilestones').value)}, ...dataManager.tests];
    $('#testTitle').value=''; $('#testTime').value=''; $('#projectMilestones').value='';
  }
  function renderUpcoming(){
    const box=$('#upcoming-tests'); box.innerHTML=''; const now=new Date();
    const upcoming=dataManager.tests.filter(t=> new Date(t.date)>=now).sort((a,b)=> new Date(a.date) - new Date(b.date)).slice(0,8);
    if(upcoming.length===0){ box.innerHTML='<div class="muted">No upcoming items.</div>'; return; }
    upcoming.forEach(t=>{ const sub = dataManager.subjects.find(s=>s.id===t.subjectId); const div = document.createElement('div'); div.className='chip'; div.innerHTML = `<div class="between"><span><strong>${t.title}</strong>${sub?` ‚Äî <span style="color:${sub.color}">${sub.name}</span>`:''} ‚Ä¢ ${t.type}</span><span class="muted small">${t.date} ${t.time||''}</span></div>`; box.appendChild(div); })
  }

  // ---------- Daily Tasks ----------
  function renderDailyTasks() {
      let tasks = dataManager.dailyTasks;
      if (tasks.lastReset !== todayISO()) {
          tasks.items.forEach(t => t.done = false);
          tasks.lastReset = todayISO();
          dataManager.dailyTasks = tasks;
      }
      const box = $('#daily-tasks-list'); box.innerHTML = '';
      if (!tasks.items.length) { box.innerHTML = `<div class="muted">No daily tasks added.</div>`; return; }
      tasks.items.forEach(task => {
          const item = document.createElement('div');
          item.className = 'chip task-item';
          item.innerHTML = `<input type="checkbox" id="task-${task.id}" ${task.done ? 'checked' : ''}><label for="task-${task.id}">${task.text}</label><button data-del class="secondary tiny">üóëÔ∏è</button>`;
          item.querySelector('input').onchange = (e) => {
              task.done = e.target.checked;
              dataManager.dailyTasks = { ...dataManager.dailyTasks, items: dataManager.dailyTasks.items.map(t => t.id === task.id ? task : t) };
          };
          item.querySelector('[data-del]').onclick = () => {
              if (confirm('Delete this task?')) { dataManager.dailyTasks = { ...dataManager.dailyTasks, items: dataManager.dailyTasks.items.filter(t => t.id !== task.id) }; }
          };
          box.appendChild(item);
      });
  }
  $('#addDailyTaskBtn').onclick = () => {
      const text = prompt('New daily task:');
      if (text) {
          let tasks = dataManager.dailyTasks;
          tasks.items.push({ id: uuid(), text, done: false });
          dataManager.dailyTasks = tasks;
      }
  };

  // ---------- Notifications, Export, Reset, Themes ----------
  function scheduleAll(){ if(Notification.permission!=="granted") return; dataManager.tests.forEach(t=>{ if(t.time){ const ms = new Date(`${t.date}T${t.time}`) - Date.now() - 30*60000; if(ms>0) setTimeout(()=>new Notification(`Upcoming: ${t.title}`),ms) }}); }
  $('#notifBtn').onclick=()=>{ Notification.requestPermission().then(p=>alert('Permission: '+p)) };
  $('#exportBtn').onclick=()=>{ const data=JSON.stringify(appData,null,2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download='study-tracker.json'; a.click(); }
  $('#importFile').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); appData = { ...getInitialState(), ...data }; saveData().then(() => { applyTheme(appData.theme); refreshAll(); }); }catch(err){alert('Invalid JSON')} }; r.readAsText(f); }
  $('#resetBtn').onclick=()=>{ if(!confirm('Reset all your data? This cannot be undone!')) return; appData = getInitialState(); appData.subjects = [ {id: uuid(), name: 'Math', color: '#7dd3fc', weeklyGoal: 300}, {id: uuid(), name: 'Biology', color: '#c4b5fd', weeklyGoal: 240}, ]; saveData().then(refreshAll); }
  function applyTheme(themeName) { document.body.dataset.theme = themeName; $('#themeSelector').value = themeName; }
  $('#themeSelector').onchange = (e) => { dataManager.theme = e.target.value; };

  // ---------- Reminders ----------
  $('#addReminder').onclick = ()=>{ const text = $('#reminderText').value.trim(); if(!text) return; dataManager.reminders = [{id:uuid(), text}, ...dataManager.reminders]; $('#reminderText').value=''; }
  function renderReminders(){
    const box = $('#reminders-list'); box.innerHTML=''; if(!dataManager.reminders.length){ box.innerHTML='<div class="muted">No reminders.</div>'; return; }
    dataManager.reminders.slice(0,12).forEach(r=>{ const item=document.createElement('div'); item.className='chip'; item.innerHTML = `<div class="between" style="width:100%"><span>${r.text}</span><button class="secondary tiny" data-del>Delete</button></div>`; item.querySelector('[data-del]').onclick = ()=>{ if(confirm('Delete reminder?')) dataManager.reminders = dataManager.reminders.filter(x=>x.id!==r.id); }; box.appendChild(item); });
  }

  // ---------- Homework ----------
  $('#addHwBtn').onclick = ()=>{ const title = $('#hwTitle').value.trim(); if(!title) return; dataManager.homework = [{ id: uuid(), title, subjectId: $('#hwSubject').value||null, due: $('#hwDate').value||'', notes: $('#hwNotes').value||'', done:false, importance: 'auto' }, ...dataManager.homework]; $('#hwTitle').value=''; $('#hwDate').value=''; $('#hwNotes').value=''; };
  function renderHomeworkList(){
    const box = $('#hwList'); box.innerHTML=''; if(!dataManager.homework.length){ box.innerHTML = '<div class="muted">No homework logged.</div>'; return; }
    dataManager.homework.sort((a,b)=> (a.done-b.done) || (new Date(a.due) - new Date(b.due))).forEach(hw=>{
      const sub = dataManager.subjects.find(s=>s.id===hw.subjectId); const imp = hw.importance || 'auto';
      const item = document.createElement('div'); item.className='chip';
      item.innerHTML = `<div class="between" style="width:100%"><div class="row" style="align-items:start; flex-grow:1;"><div style="width:10px;height:10px;border-radius:3px;background:${sub?sub.color:'transparent'}; margin-top:5px;"></div><div><div ${hw.done?'style="text-decoration:line-through;opacity:.6"':''}><strong>${hw.title}</strong> ${sub?`‚Ä¢ <span style="color:${sub.color}">${sub.name}</span>`:''}</div><div class="muted small">${hw.due?('Due: '+hw.due):'No due date'} ${hw.notes?('‚Ä¢ '+hw.notes):''}</div></div></div><div class="row">${`<select class="hw-importance tiny" data-id="${hw.id}"><option value="auto"${imp=='auto'?' selected':''}>Auto</option><option value="low"${imp=='low'?' selected':''}>Low</option><option value="medium"${imp=='medium'?' selected':''}>Medium</option><option value="high"${imp=='high'?' selected':''}>High</option><option value="critical"${imp=='critical'?' selected':''}>Critical</option></select>`}<button class="secondary tiny" data-toggle>${hw.done?'Undo':'Done'}</button><button class="secondary tiny" data-del>üóëÔ∏è</button></div></div>`;
      item.querySelector('[data-toggle]').onclick = ()=>{ dataManager.homework = dataManager.homework.map(x=> x.id===hw.id? {...hw,done:!hw.done}:x); };
      item.querySelector('[data-del]').onclick = ()=>{ if(confirm('Delete homework?')) dataManager.homework = dataManager.homework.filter(x=>x.id!==hw.id); };
      item.querySelector('.hw-importance').onchange = (e)=>{ dataManager.homework = dataManager.homework.map(x=> x.id===hw.id? {...hw, importance: e.target.value}:x); };
      box.appendChild(item);
    });
  }

  // ---------- Graph ----------
  function renderGraph(period = 'all'){
    const container = $('#graph-container'); const canvas = $('#graphCanvas');
    let sessions = dataManager.sessions;
    const now = new Date();
    if(period === 'week') { const start = startOfWeek(now); sessions = sessions.filter(s => new Date(s.at) >= start); }
    if(period === 'month') { const start = startOfMonth(now); sessions = sessions.filter(s => new Date(s.at) >= start); }
    
    const totals = dataManager.subjects.map(s=>{ const mins = sessions.filter(x=>x.subjectId===s.id).reduce((a,b)=>a+b.minutes,0); return { name:s.name, color:s.color, mins }; }).filter(t => t.mins > 0).sort((a,b)=>b.mins-a.mins);
    if(totals.length === 0) { container.innerHTML = '<div class="muted" style="text-align:center; padding: 40px;">No study data for this period.</div>'; return; } else { container.innerHTML = ''; container.appendChild(canvas); }

    const paddingLeft = 120, paddingTop = 18, lineH = 20, gap = 12;
    const totalHeight = paddingTop * 2 + totals.length * (lineH + gap);
    canvas.style.height = totalHeight + 'px'; canvas.width = container.clientWidth * devicePixelRatio; canvas.height = totalHeight * devicePixelRatio;
    const ctx = canvas.getContext('2d'); if (!ctx) { return; }
    ctx.scale(devicePixelRatio, devicePixelRatio); ctx.clearRect(0,0,canvas.width,canvas.height);
    const availableW = container.clientWidth - paddingLeft - 40; const max = Math.max(1, ...totals.map(t=>t.mins));
    ctx.font = '12px "Roboto Mono", "Courier New", Menlo, Monaco, monospace';
    totals.forEach((t,i)=>{
      const y = paddingTop + i*(lineH+gap);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text') || '#e6eef6';
      ctx.fillText(t.name, 12, y+12);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--ghost-bg') || 'rgba(255,255,255,0.03)';
      ctx.fillRect(paddingLeft, y, availableW, 14);
      const w = (t.mins/max) * availableW; ctx.fillStyle = t.color || 'var(--accent)';
      ctx.fillRect(paddingLeft, y, Math.max(6, w), 14);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted') || '#9aa6b2';
      ctx.fillText((t.mins/60).toFixed(1)+'h', paddingLeft + availableW + 8, y+12);
    });
  }
  $('#graph-filters').addEventListener('click', e => {
      if(e.target.matches('.tab')) {
          $$('#graph-filters .tab').forEach(t=>t.classList.remove('active'));
          e.target.classList.add('active');
          renderGraph(e.target.dataset.period);
      }
  });


  // ---------- Refresh / Init ----------
  function refreshAll(){
    renderSubjects(); renderRecent(); renderKPIs(); renderGoalsDashboard();
    renderUpNext(); renderCalendar(); renderUpcoming(); scheduleAll();
    renderReminders(); renderHomeworkList(); renderDailyTasks();
  }

  (function init(){ 
    const deleteZone = $('#delete-zone');
    deleteZone.addEventListener('dragover', handleDragOver);
    deleteZone.addEventListener('dragenter', handleDragEnter);
    deleteZone.addEventListener('dragleave', handleDragLeave);
    deleteZone.addEventListener('drop', handleDropOnDelete);
  })();
</script>
</body>
</html>
