<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Guide Maker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMcApdbeGgwqiAUoBGH70ezgOKBKtsAIcVNDKOZ2p2b6FOx4" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzYCACeUdcIQLs5UWJTEbOPoF2GcVYLDRrf" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" onload="renderMathInElement(document.body);"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
        }

        /* --- Theme Variables --- */
        body[data-theme="cute-pink"] {
            --bg-main: #fcefee;
            --bg-pattern: #ffc09f;
            --primary: #ff8fab;
            --primary-hover: #ff7aa2;
            --secondary: #a2d2ff;
            --secondary-hover: #8ec9ff;
            --accent: #ffc09f;
            --accent-hover: #ffb38a;
            --green: #80ed99;
            --green-hover: #6ee089;
            --text-main: #5e5e5e;
            --text-header: #d46c8b;
            --card-border: #fde2e4;
            --tab-bg: #fde2e4;
            --tab-text: #d46c8b;
            --tab-active-text: #d46c8b;
        }
         body[data-theme="ocean-blue"] {
            --bg-main: #f0f8ff;
            --bg-pattern: #a2d2ff;
            --primary: #0077b6;
            --primary-hover: #006da4;
            --secondary: #00b4d8;
            --secondary-hover: #00a2c2;
            --accent: #90e0ef;
            --accent-hover: #81cae5;
            --green: #48cae4;
            --green-hover: #41b6cd;
            --text-main: #03045e;
            --text-header: #023e8a;
            --card-border: #caf0f8;
            --tab-bg: #ade8f4;
            --tab-text: #03045e;
            --tab-active-text: #023e8a;
        }
        body[data-theme="forest-green"] {
            --bg-main: #f4f8f4;
            --bg-pattern: #a3b18a;
            --primary: #588157;
            --primary-hover: #4e734d;
            --secondary: #3a5a40;
            --secondary-hover: #314d36;
            --accent: #a3b18a;
            --accent-hover: #93a07b;
            --green: #dad7cd;
            --green-hover: #c9c5bb;
            --text-main: #344e41;
            --text-header: #3a5a40;
            --card-border: #dad7cd;
            --tab-bg: #dad7cd;
            --tab-text: #3a5a40;
            --tab-active-text: #344e41;
        }

        body { background-color: var(--bg-main); color: var(--text-main); }
        h1, h2, h3, h4 { color: var(--text-header); }
        .nav-tab-container { background-color: var(--tab-bg); }
        .nav-tab { color: var(--tab-text); }
        .nav-tab.active { color: var(--tab-active-text); }
        .card { border-color: var(--card-border); }
        .modal-card { border-color: var(--primary); }
        .input-style:focus { border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, transparent); }

        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill-opacity='0.1'%3E%3Cpath fill='%23a2d2ff' d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -1;
        }
        
        .cute-btn { border-radius: 12px; padding: 8px 16px; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .cute-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.1); }
        .cute-btn:active { transform: translateY(0px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: var(--secondary-hover); }
        .btn-accent { background-color: var(--accent); color: white; }
        .btn-accent:hover { background-color: var(--accent-hover); }
        .btn-green { background-color: var(--green); color: var(--text-main); }
        .btn-green:hover { background-color: var(--green-hover); }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        
        .card { background-color: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; border-width: 1px; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .modal-card { border-radius: 20px; border-width: 2px; }
        .input-style { border-radius: 10px; border: 1px solid #ddd; padding: 8px 12px; transition: box-shadow 0.2s, border-color 0.2s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .katex { font-size: 1.1em !important; } /* Ensure consistent LaTeX sizing */
        
        /* Drag and Drop Trash Can */
        #trash-can { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); transition: bottom 0.3s ease-in-out, transform 0.2s; z-index: 100; }
        #trash-can.visible { bottom: 20px; }
        #trash-can.over { transform: translateX(-50%) scale(1.1); background-color: #ef4444 !important; }

        /* Draggable Item Styling */
        .draggable-item, .draggable-grid-item { cursor: grab; }
        .draggable-item:active, .draggable-grid-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; } /* Ghost item style for SortableJS */
        .dragging { opacity: 0.5; transform: rotate(2deg); box-shadow: 0 10px 20px rgba(0,0,0,0.2); } /* Style for native draggable items */

        /* Flashcard Animation */
        .flashcard-container { perspective: 1000px; min-height: 150px; cursor: pointer; }
        .flashcard { position: relative; width: 100%; height: 100%; min-height: 150px; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; padding: 1rem; }
        .flashcard-back { transform: rotateY(180deg); }
    </style>
</head>
<body data-theme="cute-pink">

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-bold">Study Guide Maker</h1>
            <div>
                <button id="theme-settings-btn" class="cute-btn btn-secondary mr-2" title="Customize Theme">&#127912;</button>
                <button id="home-button" class="cute-btn btn-primary">Home</button>
            </div>
        </header>

        <main id="content-area"></main>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white modal-card p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"></div>
    </div>
    
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60] cursor-pointer">
        <img id="enlarged-image" src="" alt="Enlarged view" class="max-w-full max-h-full object-contain">
    </div>

    <div id="trash-can" class="bg-red-500 text-white p-4 rounded-full shadow-lg flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contentArea = document.getElementById('content-area');
            const homeButton = document.getElementById('home-button');
            const themeSettingsButton = document.getElementById('theme-settings-btn');
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const imageModal = document.getElementById('image-modal');
            const enlargedImage = document.getElementById('enlarged-image');
            const trashCan = document.getElementById('trash-can');

            let studyData = { folders: [], settings: { theme: 'cute-pink' } };
            let currentState = { view: 'folders', currentFolderId: null, currentSubfolderId: null };
            let sortableInstance = null;
            let trashSortableInstance = null;

            // --- DATA and STATE MANAGEMENT ---
            function saveData() {
                localStorage.setItem('studyGuideData', JSON.stringify(studyData));
            }

            function loadData() {
                const data = localStorage.getItem('studyGuideData');
                if (data) {
                    studyData = JSON.parse(data);
                    // Ensure defaults for new features
                    if (!studyData.settings) studyData.settings = { theme: 'cute-pink' };
                    studyData.folders.forEach(f => {
                        if (!f.color) f.color = '#ff8fab';
                        if (!f.subfolders) f.subfolders = [];
                        if (f.disabledFeatures === undefined) f.disabledFeatures = [];
                        f.subfolders.forEach(sf => {
                            if(!sf.examples) sf.examples = [];
                            sf.examples.forEach(ex => { if(ex.imageUrl === undefined) ex.imageUrl = ''; });
                        });
                    });
                }
            }
            
            function applyTheme() {
                document.body.dataset.theme = studyData.settings.theme;
            }

            // --- UTILITY FUNCTIONS ---
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const findFolder = (folderId) => studyData.folders.find(f => f.id === folderId);
            
            const getCurrentContent = () => {
    if (currentState.view === 'folders') return null;
    const folder = findFolder(currentState.currentFolderId);
    if (!folder) return null;

    // If a subfolder is selected, return the actual subfolder object (NOT a copy)
    if (currentState.currentSubfolderId) {
        const subfolder = folder.subfolders.find(sf => sf.id === currentState.currentSubfolderId);
        if (!subfolder) return null;
        // Ensure the subfolder object has a parentFolder reference (this mutates the actual stored object)
        subfolder.parentFolder = folder;
        return subfolder;
    }

    // Aggregated "All Units" view (read-only combined arrays)
    return {
        name: `${folder.name} (All Units)`,
        vocabulary: folder.subfolders.flatMap(sf => sf.vocabulary || []),
        timeline: folder.subfolders.flatMap(sf => sf.timeline || []),
        practiceQuestions: folder.subfolders.flatMap(sf => sf.practiceQuestions || []),
        examples: folder.subfolders.flatMap(sf => sf.examples || []),
        isAggregated: true,
        parentFolder: folder
    };
};


    // Aggregated "All Units" view (read-only combined arrays)
    return {
        name: `${folder.name} (All Units)`,
        vocabulary: folder.subfolders.flatMap(sf => sf.vocabulary || []),
        timeline: folder.subfolders.flatMap(sf => sf.timeline || []),
        practiceQuestions: folder.subfolders.flatMap(sf => sf.practiceQuestions || []),
        examples: folder.subfolders.flatMap(sf => sf.examples || []),
        isAggregated: true,
        parentFolder: folder
    };
};
            
            const renderMath = (element) => {
                if (window.renderMathInElement) {
                    renderMathInElement(element, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}] });
                }
            };

            // --- MODAL CONTROLS ---
            function showModal(htmlContent) {
                modalContent.innerHTML = htmlContent;
                modal.classList.remove('hidden');
                modalContent.scrollTop = 0; // Scroll to top
                renderMath(modalContent);
            }
            function closeModal() { modal.classList.add('hidden'); }
            function showImageModal(src) { enlargedImage.src = src; imageModal.classList.remove('hidden'); }
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            imageModal.addEventListener('click', () => imageModal.classList.add('hidden'));

            // --- NAVIGATION ---
            function navigate(view, folderId = null, subfolderId = null) {
                currentState = { view, currentFolderId: folderId, currentSubfolderId: subfolderId };
                render();
            }
            homeButton.addEventListener('click', () => navigate('folders'));

            // --- RENDERING ENGINE ---
            function render() {
                contentArea.innerHTML = '';
                switch (currentState.view) {
                    case 'folders': renderFoldersPage(); break;
                    case 'subfolders': renderSubfoldersPage(); break;
                    default: renderContentPage(); break;
                }
                renderMath(contentArea);
            }
            
            // --- PAGE RENDERERS ---
            function renderFoldersPage() {
                let folderGrid = '';
                if (studyData.folders.length > 0) {
                    folderGrid = studyData.folders.map(folder => `
                        <div class="card p-4 flex flex-col justify-between fade-in draggable-grid-item" draggable="true" data-folder-id="${folder.id}" style="border-top: 5px solid ${folder.color || 'var(--primary)'};">
                            <h3 class="text-xl font-semibold truncate">${folder.name}</h3>
                            <div class="mt-4 flex items-center justify-between">
                                <button data-folder-id="${folder.id}" class="view-folder-btn cute-btn btn-primary text-sm">Open</button>
                                <button data-folder-id="${folder.id}" class="edit-folder-btn text-gray-500 hover:text-[var(--primary)] p-1 rounded-full transition" title="Edit Class">&#9998;</button>
                            </div>
                        </div>`).join('');
                } else {
                    folderGrid = `<div class="col-span-full card text-center p-12 fade-in">
                        <h3 class="text-2xl font-semibold text-gray-700">Welcome!</h3>
                        <p class="mt-2 text-gray-500">You don't have any classes yet. Click "New Class" to get started.</p>
                    </div>`;
                }

                contentArea.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold">My Classes</h2>
                        <button id="add-folder-btn" class="cute-btn btn-green">New Class</button>
                    </div>
                    <div id="folder-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">${folderGrid}</div>`;
                
                if (studyData.folders.length > 0) {
                    setupGridDragToDelete();
                }
            }
            
            function renderSubfoldersPage() {
                const folder = findFolder(currentState.currentFolderId);
                if (!folder) return navigate('folders');

                const subfolderGrid = folder.subfolders.map(sf => `
                    <div class="card p-4 flex flex-col justify-between fade-in draggable-grid-item" draggable="true" data-subfolder-id="${sf.id}">
                        <h3 class="text-xl font-semibold truncate">${sf.name}</h3>
                        <div class="mt-4 flex items-center justify-between">
                            <button data-subfolder-id="${sf.id}" class="view-subfolder-btn cute-btn btn-primary text-sm">Open</button>
                            <button data-subfolder-id="${sf.id}" class="edit-subfolder-btn text-gray-500 hover:text-[var(--primary)] p-1 rounded-full transition" title="Edit Unit">&#9998;</button>
                        </div>
                    </div>`).join('');
                contentArea.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold">${folder.name}</h2>
                        <div>
                            <button id="class-settings-btn" class="cute-btn btn-accent mr-2">Settings</button>
                            <button id="view-all-btn" class="cute-btn btn-secondary mr-2">View All</button>
                            <button id="add-subfolder-btn" class="cute-btn btn-green">New Unit</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">${subfolderGrid}</div>`;
                setupGridDragToDelete();
            }

            function renderContentPage() {
                const content = getCurrentContent();
                if (!content) return navigate('folders');
                const isAggregated = content.isAggregated || false;
                const features = [
                    { id: 'vocabulary', name: 'Vocabulary' }, { id: 'timeline', name: 'Timeline' },
                    { id: 'practiceQuestions', name: 'Practice Questions' }, { id: 'examples', name: 'Examples' }
                ].filter(f => !(content.parentFolder.disabledFeatures || []).includes(f.id));
                if (features.length > 0 && !features.find(f => f.id === currentState.view)) {
                    currentState.view = features[0].id;
                }
                const navTabs = `<div class="flex space-x-1 rounded-xl p-1 mb-4 nav-tab-container">
                    ${features.map(view => `<button class="nav-tab w-full rounded-lg py-2 text-sm font-medium transition ${currentState.view === view.id ? 'bg-white shadow active' : 'hover:bg-white/[0.6]'}" data-view="${view.id}">${view.name}</button>`).join('')}
                </div>`;
                let pageContent = '', addButton = '', actionButtons = '';
                const currentFeatureData = content[currentState.view] || [];
                switch (currentState.view) {
                    case 'vocabulary':
                        pageContent = renderVocabulary(currentFeatureData);
                        if (!isAggregated) { addButton = `<button id="add-vocab-btn" class="cute-btn btn-green">Add Vocab</button>`; actionButtons = `<button id="practice-flashcards-btn" class="cute-btn btn-secondary ml-2">Practice Flashcards</button>`; }
                        break;
                    case 'timeline':
                        pageContent = renderTimeline(currentFeatureData);
                        if (!isAggregated) addButton = `<button id="add-timeline-btn" class="cute-btn btn-green">Add Event</button>`;
                        break;
                    case 'practiceQuestions':
                        pageContent = renderPracticeQuestions(currentFeatureData);
                        if (!isAggregated) addButton = `<button id="add-question-btn" class="cute-btn btn-green">Add Question</button>`;
                        break;
                    case 'examples':
                        pageContent = renderExamples(currentFeatureData);
                        if (!isAggregated) addButton = `<button id="add-example-btn" class="cute-btn btn-green">Add Example</button>`;
                        break;
                }
                contentArea.innerHTML = `
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 class="text-3xl font-bold">${content.name}</h2>
                        <div class="flex items-center flex-wrap gap-2">
                            <button id="export-pdf-btn" class="cute-btn btn-accent">Export PDF</button>
                            ${addButton} ${actionButtons}
                        </div>
                    </div>
                    ${features.length > 0 ? navTabs : ''}
                    <div id="page-content-container">${pageContent}</div>`;
                if (!isAggregated) setupListDragToDelete();
            }

            // --- Component Renderers ---
            function renderVocabulary(vocabList) {
                if (vocabList.length === 0) return `<div class="card text-center p-8"><p>No vocabulary terms yet!</p></div>`;
                return `<div class="space-y-4 sortable-list">${vocabList.map(item => `
                    <div class="card p-4 flex items-start gap-4 fade-in draggable-item" data-item-id="${item.id}">
                        <div class="flex-grow">
                            <div class="flex justify-between items-center"><h4 class="text-lg font-semibold">${item.term}</h4></div>
                            <p class="text-gray-600 mt-1">${item.definition}</p>
                        </div>
                        <button data-id="${item.id}" class="edit-vocab-btn text-gray-500 hover:text-[var(--primary)] p-1 rounded-full transition" title="Edit Vocab">&#9998;</button>
                    </div>`).join('')}</div>`;
            }
            function renderTimeline(events, parentId = null, level = 0) {
                 return (events || []).length === 0 && level === 0 ? `<div class="card text-center p-8"><p>Your timeline is empty.</p></div>` : `<div class="${level === 0 ? 'space-y-4 sortable-list' : 'mt-3 pl-4 border-l-2 border-[var(--primary)] timeline-children'}">${(events||[]).filter(e=>e.parentId===parentId).sort((a,b)=>(a.era==='BCE'?-a.year:a.year)-(b.era==='BCE'?-b.year:b.year)).map(event=>`<div class="timeline-event ${event.collapsed?'collapsed':''} fade-in" style="margin-left:${level*20}px;"><div class="relative card p-4 flex gap-4 draggable-item" data-item-id="${event.id}">${events.some(e=>e.parentId===event.id)?`<button class="absolute -left-7 top-6 text-[var(--primary)] collapse-btn" data-id="${event.id}"><svg class="collapse-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>`:''}<div class="flex-grow"><div class="flex justify-between items-start"><div><h4 class="${event.isSubheading?'text-xl font-bold':'text-lg font-semibold'}">${event.title}</h4><p class="text-sm font-medium text-gray-500">${event.dayMonth||''} ${event.year} ${event.era}</p></div><button data-id="${event.id}" class="edit-timeline-btn text-gray-500 hover:text-[var(--primary)] p-1 rounded-full transition" title="Edit Event">&#9998;</button></div><p class="text-gray-600 mt-2">${event.description}</p>${event.imageUrl?`<img src="${event.imageUrl}" alt="Timeline image" class="mt-3 rounded-lg max-h-40 cursor-pointer image-preview">`:''}</div></div>${renderTimeline(events,event.id,level+1)}</div>`).join('')}</div>`; 
            }
            function renderPracticeQuestions(questions) {
                if (questions.length === 0) return `<div class="card text-center p-8"><p>No practice questions here.</p></div>`;
                return `<div class="space-y-4 sortable-list">${questions.map(item => `
                    <div class="card p-4 fade-in draggable-item" data-item-id="${item.id}">
                        <div class="flex justify-between items-start">
                            <div class="prose max-w-none text-gray-700 w-full">
                                <div>${item.question}</div>
                                ${item.options && item.options.length > 0 ? `<div class="mt-2 space-y-1">${item.options.map((opt, i) => `<div class="text-sm"><strong>${String.fromCharCode(65 + i)}.</strong> ${opt}</div>`).join('')}</div>` : ''}
                                ${item.solution ? `<details class="mt-2 text-sm"><summary class="cursor-pointer font-semibold">View Solution</summary><div class="p-2 bg-gray-50 rounded-lg mt-1">${item.solution}</div></details>` : ''}
                            </div>
                            <button data-id="${item.id}" class="edit-question-btn text-gray-500 hover:text-[var(--primary)] p-1 rounded-full transition" title="Edit Question">&#9998;</button>
                        </div>
                       ${item.imageUrl ? `<img src="${item.imageUrl}" alt="Question image" class="mt-3 rounded-lg max-h-40 cursor-pointer image-preview">` : ''}
                    </div>`).join('')}</div>`;
            }
            function renderExamples(examples) {
                 if (examples.length === 0) return `<div class="card text-center p-8"><p>No examples saved.</p></div>`;
                 return `<div class="space-y-4 sortable-list">${examples.map(item => `
                    <div class="card p-4 fade-in draggable-item" data-item-id="${item.id}">
                        <div class="flex justify-between items-start w-full">
                            <div class="flex-grow cursor-pointer view-example-btn" data-id="${item.id}"><h4 class="text-lg font-semibold">${item.title}</h4></div>
                            <button data-id="${item.id}" class="edit-example-btn text-gray-500 hover:text-[var(--primary)] p-1 rounded-full transition" title="Edit Example">&#9998;</button>
                        </div>
                    </div>`).join('')}</div>`;
            }

            // --- Drag and Drop Deletion ---
            function setupListDragToDelete() {
                const listEl = contentArea.querySelector('.sortable-list');
                if (!listEl) return;
                
                const deleteItem = (itemId) => {
                    const content = getCurrentContent();
                    if (!content.isAggregated && content[currentState.view]) {
                        content[currentState.view] = content[currentState.view].filter(i => i.id !== itemId);
                        saveData();
                        render();
                    }
                };

                if (sortableInstance) sortableInstance.destroy();
                if (trashSortableInstance) trashSortableInstance.destroy();

                sortableInstance = new Sortable(listEl, {
                    group: 'shared', animation: 150, ghostClass: 'sortable-ghost',
                    onStart: () => trashCan.classList.add('visible'),
                    onEnd: (evt) => {
                        trashCan.classList.remove('visible', 'over');
                        const list = getCurrentContent()[currentState.view];
                        if (evt.to !== trashCan && list) {
                            const { oldIndex, newIndex } = evt;
                            list.splice(newIndex, 0, list.splice(oldIndex, 1)[0]);
                            saveData();
                        }
                    }
                });
                
                trashSortableInstance = new Sortable(trashCan, {
                    group: 'shared',
                    onAdd: (evt) => {
                        const itemId = evt.item.dataset.itemId;
                        evt.item.remove();
                        if (itemId) deleteItem(itemId);
                    },
                    onDragEnter: () => trashCan.classList.add('over'),
                    onDragLeave: () => trashCan.classList.remove('over')
                });
            }

            function setupGridDragToDelete() {
                const items = contentArea.querySelectorAll('.draggable-grid-item');
                items.forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                });
                trashCan.addEventListener('dragover', handleDragOver);
                trashCan.addEventListener('dragenter', handleDragEnter);
                trashCan.addEventListener('dragleave', handleDragLeave);
                trashCan.addEventListener('drop', handleDrop);
            }

            function handleDragStart(e) {
                trashCan.classList.add('visible');
                e.target.classList.add('dragging');
                if (e.target.dataset.folderId) {
                    e.dataTransfer.setData('text/plain', `folder:${e.target.dataset.folderId}`);
                } else if (e.target.dataset.subfolderId) {
                    e.dataTransfer.setData('text/plain', `subfolder:${e.target.dataset.subfolderId}`);
                }
            }
            function handleDragEnd(e) {
                trashCan.classList.remove('visible', 'over');
                e.target.classList.remove('dragging');
            }
            function handleDragOver(e) { e.preventDefault(); }
            function handleDragEnter(e) { e.preventDefault(); trashCan.classList.add('over'); }
            function handleDragLeave() { trashCan.classList.remove('over'); }
            function handleDrop(e) {
                e.preventDefault();
                trashCan.classList.remove('over');
                const data = e.dataTransfer.getData('text/plain');
                const [type, id] = data.split(':');
                if (type === 'folder' && id) {
                    if (confirm(`Delete class? This will delete all its units and content. This cannot be undone.`)) {
                        studyData.folders = studyData.folders.filter(f => f.id !== id);
                        saveData();
                        if (currentState.currentFolderId === id) navigate('folders'); else render();
                    }
                } else if (type === 'subfolder' && id) {
                    if (confirm('Are you sure you want to delete this unit and all its content?')) {
                        const folder = findFolder(currentState.currentFolderId);
                        if (folder) {
                            folder.subfolders = folder.subfolders.filter(sf => sf.id !== id);
                            saveData();
                            if (currentState.currentSubfolderId === id) navigate('subfolders', folder.id); else render();
                        }
                    }
                }
            }


            // --- Event Handlers & Action Handlers (CRUD) ---
            contentArea.addEventListener('click', e => {
                const handlers = {
                    '.view-folder-btn': el => navigate('subfolders', el.dataset.folderId),
                    '#add-folder-btn': handleAddFolder,
                    '.edit-folder-btn': el => handleEditFolder(el.dataset.folderId),
                    '.view-subfolder-btn': el => navigate('vocabulary', currentState.currentFolderId, el.dataset.subfolderId),
                    '#add-subfolder-btn': handleAddSubfolder,
                    '.edit-subfolder-btn': el => handleEditSubfolder(el.dataset.subfolderId),
                    '#view-all-btn': () => navigate('vocabulary', currentState.currentFolderId, null),
                    '#class-settings-btn': handleShowSettings,
                    '.nav-tab': el => navigate(el.dataset.view, currentState.currentFolderId, currentState.currentSubfolderId),
                    '#export-pdf-btn': handleExportPdf,
                    '#add-vocab-btn': handleAddVocab,
                    '.edit-vocab-btn': el => handleEditVocab(el.dataset.id),
                    '#practice-flashcards-btn': handlePracticeFlashcards,
                    '#add-timeline-btn': handleAddTimeline,
                    '.edit-timeline-btn': el => handleEditTimeline(el.dataset.id),
                    '.collapse-btn': el => handleToggleCollapse(el.dataset.id),
                    '.image-preview': el => showImageModal(el.src),
                    '#add-question-btn': handleAddQuestion,
                    '.edit-question-btn': el => handleEditQuestion(el.dataset.id),
                    '#add-example-btn': handleAddExample,
                    '.edit-example-btn': el => handleEditExample(el.dataset.id),
                    '.view-example-btn': el => handleViewExample(el.dataset.id),
                };
                for (const selector in handlers) {
                    const el = e.target.closest(selector);
                    if (el) { handlers[selector](el); return; }
                }
            });

            themeSettingsButton.addEventListener('click', handleThemeSettings);

            function handleAddFolder() { handleEditFolder(null); }
            function handleEditFolder(folderId) {
                const folder = folderId ? findFolder(folderId) : null;
                showModal(`
                    <h3 class="text-xl font-bold mb-4">${folder ? 'Edit' : 'New'} Class</h3>
                    <form id="item-form" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium">Class Name</label>
                            <input type="text" id="name" value="${folder?.name || ''}" required class="mt-1 block w-full input-style">
                        </div>
                        <div>
                            <label for="color" class="block text-sm font-medium">Class Color</label>
                            <input type="color" id="color" value="${folder?.color || '#ff8fab'}" class="mt-1 block w-full h-10">
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-cancel-btn cute-btn bg-gray-200 text-gray-800">Cancel</button>
                            <button type="submit" class="cute-btn btn-primary">Save</button>
                        </div>
                    </form>`);
                document.querySelector('.form-cancel-btn').onclick = closeModal;
                document.getElementById('item-form').onsubmit = e => {
                    e.preventDefault();
                    const name = document.getElementById('name').value.trim();
                    const color = document.getElementById('color').value;
                    if (!name) return;
                    if (folder) {
                        folder.name = name;
                        folder.color = color;
                    } else {
                        studyData.folders.push({ id: generateId(), name, color, subfolders: [], disabledFeatures: [] });
                    }
                    saveData(); render(); closeModal();
                };
            }
            
            function handleAddSubfolder() { handleEditSubfolder(null); }
            function handleEditSubfolder(subfolderId) {
                const folder = findFolder(currentState.currentFolderId);
                if (!folder) return;
                const subfolder = subfolderId ? folder.subfolders.find(sf => sf.id === subfolderId) : null;
                showModal(`
                    <h3 class="text-xl font-bold mb-4">${subfolder ? 'Edit' : 'New'} Unit</h3>
                    <form id="item-form">
                        <label for="name" class="block text-sm font-medium">Unit Name</label>
                        <input type="text" id="name" value="${subfolder?.name || ''}" required class="mt-1 block w-full input-style">
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-cancel-btn cute-btn bg-gray-200 text-gray-800">Cancel</button>
                            <button type="submit" class="cute-btn btn-primary">Save</button>
                        </div>
                    </form>`);
                document.querySelector('.form-cancel-btn').onclick = closeModal;
                document.getElementById('item-form').onsubmit = e => {
                    e.preventDefault();
                    const name = document.getElementById('name').value.trim();
                    if (!name) return;
                    if (subfolder) {
                        subfolder.name = name;
                    } else {
                        folder.subfolders.push({ id: generateId(), name, vocabulary: [], timeline: [], practiceQuestions: [], examples: [] });
                    }
                    saveData(); render(); closeModal();
                };
            }

            function handleAddVocab() { handleEditVocab(null); }
            function handleEditVocab(itemId) {
                const content = getCurrentContent();
                const item = itemId ? content.vocabulary.find(v => v.id === itemId) : null;
                showModal(`
                    <h3 class="text-xl font-bold mb-4">${item ? 'Edit' : 'Add'} Vocabulary</h3>
                    <form id="item-form" class="space-y-4">
                        <div>
                            <label for="term" class="block text-sm font-medium">Term</label>
                            <input type="text" id="term" value="${item?.term || ''}" placeholder="e.g., Photosynthesis" required class="w-full input-style">
                        </div>
                        <div>
                            <label for="definition" class="block text-sm font-medium">Definition</label>
                            <textarea id="definition" placeholder="Supports $LaTeX$..." rows="5" required class="w-full input-style">${item?.definition || ''}</textarea>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-cancel-btn cute-btn bg-gray-200">Cancel</button>
                            <button type="submit" class="cute-btn btn-primary">Save</button>
                        </div>
                    </form>`);
                document.querySelector('.form-cancel-btn').onclick = closeModal;
                document.getElementById('item-form').onsubmit = e => {
                    e.preventDefault();
                    const data = {
                        term: document.getElementById('term').value,
                        definition: document.getElementById('definition').value
                    };
                    if(item) Object.assign(item, data);
                    else content.vocabulary.push({ ...data, id: generateId() });
                    saveData(); render(); closeModal();
                };
            }
            
            function handleAddTimeline() { handleEditTimeline(null); }
            function handleEditTimeline(itemId) {
                const content = getCurrentContent();
                const item = itemId ? content.timeline.find(t => t.id === itemId) : null;
                const parentOptions = content.timeline.filter(t => t.id !== itemId).map(t => `<option value="${t.id}" ${item?.parentId === t.id ? 'selected' : ''}>${t.title}</option>`).join('');

                showModal(`
                    <h3 class="text-xl font-bold mb-4">${item ? 'Edit' : 'Add'} Timeline Event</h3>
                    <form id="item-form" class="space-y-4">
                        <input type="text" id="title" value="${item?.title || ''}" placeholder="Event Title" required class="w-full input-style">
                        <div class="grid grid-cols-3 gap-3">
                            <input type="text" id="dayMonth" value="${item?.dayMonth || ''}" placeholder="Day/Month (e.g., Jan 1)" class="w-full input-style">
                            <input type="number" id="year" value="${item?.year || ''}" placeholder="Year" required class="w-full input-style">
                            <select id="era" class="w-full input-style">
                                <option value="AD/CE" ${item?.era !== 'BCE' ? 'selected' : ''}>AD/CE</option>
                                <option value="BCE" ${item?.era === 'BCE' ? 'selected' : ''}>BCE</option>
                            </select>
                        </div>
                        <textarea id="description" placeholder="Description (Supports $LaTeX$)" rows="4" required class="w-full input-style">${item?.description || ''}</textarea>
                        <input type="url" id="imageUrl" value="${item?.imageUrl || ''}" placeholder="Image URL (Optional)" class="w-full input-style">
                        <select id="parentId" class="w-full input-style">
                            <option value="">No Parent Event</option>
                            ${parentOptions}
                        </select>
                        <label class="flex items-center gap-2"><input type="checkbox" id="isSubheading" ${item?.isSubheading ? 'checked' : ''}> Mark as subheading</label>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-cancel-btn cute-btn bg-gray-200">Cancel</button>
                            <button type="submit" class="cute-btn btn-primary">Save</button>
                        </div>
                    </form>`);
                document.querySelector('.form-cancel-btn').onclick = closeModal;
                document.getElementById('item-form').onsubmit = e => {
                    e.preventDefault();
                    const data = {
                        title: document.getElementById('title').value,
                        dayMonth: document.getElementById('dayMonth').value,
                        year: parseInt(document.getElementById('year').value),
                        era: document.getElementById('era').value,
                        description: document.getElementById('description').value,
                        imageUrl: document.getElementById('imageUrl').value,
                        parentId: document.getElementById('parentId').value || null,
                        isSubheading: document.getElementById('isSubheading').checked,
                        collapsed: item?.collapsed || false
                    };
                    if (item) Object.assign(item, data);
                    else content.timeline.push({ ...data, id: generateId() });
                    saveData(); render(); closeModal();
                };
            }

            function handleToggleCollapse(itemId) {
                const content = getCurrentContent();
                const item = content.timeline.find(t => t.id === itemId);
                if (item) { item.collapsed = !item.collapsed; saveData(); render(); }
            }

            function handleAddQuestion() { handleEditQuestion(null); }
            function handleEditQuestion(itemId) {
                const content = getCurrentContent();
                const item = itemId ? content.practiceQuestions.find(q => q.id === itemId) : null;
                
                showModal(`
                    <h3 class="text-xl font-bold mb-4">${item ? 'Edit' : 'Add'} Question</h3>
                    <form id="item-form" class="space-y-4">
                         <textarea id="question" placeholder="Question text (Supports $LaTeX$)" rows="4" required class="w-full input-style">${item?.question || ''}</textarea>
                         <div id="mc-options" class="space-y-2"></div>
                         <button type="button" id="add-option-btn" class="cute-btn btn-secondary text-sm">Add MC Option</button>
                         <textarea id="solution" placeholder="Solution/Answer (Supports $LaTeX$)" rows="4" class="w-full input-style">${item?.solution || ''}</textarea>
                         <input type="url" id="imageUrl" value="${item?.imageUrl || ''}" placeholder="Image URL (Optional)" class="w-full input-style">
                         <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-cancel-btn cute-btn bg-gray-200">Cancel</button>
                            <button type="submit" class="cute-btn btn-primary">Save</button>
                        </div>
                    </form>`);
                
                const optionsContainer = document.getElementById('mc-options');
                const addOption = (value = '') => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `<input type="text" class="mc-option w-full input-style" value="${value}" placeholder="Option text"><button type="button" class="remove-option text-red-500 font-bold">âœ–</button>`;
                    div.querySelector('.remove-option').onclick = () => div.remove();
                    optionsContainer.appendChild(div);
                };

                (item?.options || []).forEach(opt => addOption(opt));
                document.getElementById('add-option-btn').onclick = () => addOption();
                document.querySelector('.form-cancel-btn').onclick = closeModal;

                document.getElementById('item-form').onsubmit = e => {
                    e.preventDefault();
                    const options = Array.from(document.querySelectorAll('.mc-option')).map(inp => inp.value).filter(Boolean);
                    const data = {
                        question: document.getElementById('question').value,
                        solution: document.getElementById('solution').value,
                        imageUrl: document.getElementById('imageUrl').value,
                        options: options
                    };
                    if (item) Object.assign(item, data);
                    else content.practiceQuestions.push({ ...data, id: generateId() });
                    saveData(); render(); closeModal();
                };
            }
            
            function handleAddExample() { handleEditExample(null); }
            function handleEditExample(itemId) {
                const content = getCurrentContent();
                const item = itemId ? content.examples.find(q => q.id === itemId) : null;
                showModal(`
                    <h3 class="text-xl font-bold mb-4">${item ? 'Edit' : 'Add'} Example</h3>
                    <form id="item-form" class="space-y-4">
                         <input type="text" id="title" value="${item?.title || ''}" placeholder="Example Title" required class="w-full input-style">
                         <textarea id="content" placeholder="Content/Solution (Supports $...$ and $$...$$ for math)" rows="8" required class="w-full input-style">${item?.content || ''}</textarea>
                         <input type="url" id="imageUrl" value="${item?.imageUrl || ''}" placeholder="Image URL (Optional)" class="w-full input-style">
                         <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-cancel-btn cute-btn bg-gray-200">Cancel</button>
                            <button type="submit" class="cute-btn btn-primary">Save</button>
                        </div>
                    </form>`);
                document.querySelector('.form-cancel-btn').onclick = closeModal;
                document.getElementById('item-form').onsubmit = e => {
                    e.preventDefault();
                    const data = {
                        title: document.getElementById('title').value,
                        content: document.getElementById('content').value,
                        imageUrl: document.getElementById('imageUrl').value,
                    };
                    if (item) Object.assign(item, data);
                    else content.examples.push({ ...data, id: generateId() });
                    saveData(); render(); closeModal();
                };
            }

            function handleViewExample(itemId) {
                const content = getCurrentContent();
                const item = content.examples.find(i => i.id === itemId);
                if (!item) return;
                showModal(`
                    <div class="prose max-w-none">
                        <h3 class="text-xl font-bold mb-4">${item.title}</h3>
                        ${item.imageUrl ? `<img src="${item.imageUrl}" alt="Example image" class="mb-4 rounded-lg max-h-60 w-auto mx-auto">` : ''}
                        <div>${item.content}</div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" class="form-close-btn cute-btn bg-gray-200">Close</button>
                            <button type="button" id="edit-example-from-view" class="cute-btn btn-primary">Edit</button>
                        </div>
                    </div>`);
                document.querySelector('.form-close-btn').onclick = closeModal;
                document.getElementById('edit-example-from-view').onclick = () => { handleEditExample(itemId); };
            }

            function handlePracticeFlashcards() {
    const content = getCurrentContent();
    if (!content || !content.vocabulary || content.vocabulary.length === 0) {
        alert('No vocabulary to practice in this unit.');
        return;
    }

    const cards = content.vocabulary.slice(); // local copy for shuffle
    let index = 0;

    const buildModalHTML = () => {
        const card = cards[index];
        return `
            <h3 class="text-xl font-bold mb-4">Flashcards â€” ${content.name}</h3>
            <div class="flashcard-container w-full max-w-2xl mx-auto p-4">
                <div id="flashcard" class="flashcard card p-6">
                    <div class="flashcard-face front">${card.term}</div>
                    <div class="flashcard-face flashcard-back back">${card.definition}</div>
                </div>
                <div class="mt-4 flex justify-between items-center gap-2">
                    <button id="prev-card" class="cute-btn btn-secondary">Prev</button>
                    <div class="flex gap-2">
                        <button id="shuffle-cards" class="cute-btn btn-accent">Shuffle</button>
                        <button id="flip-card" class="cute-btn btn-primary">Flip</button>
                    </div>
                    <button id="next-card" class="cute-btn btn-secondary">Next</button>
                </div>
            </div>
            <div class="mt-3 text-sm text-gray-500">Click the card or press "Flip" to toggle answer. Math is supported.</div>
        `;
    };

    // show modal with the current card
    showModal(buildModalHTML());

    // attach handlers after modal is shown
    setTimeout(() => {
        const flashcardEl = modalContent.querySelector('#flashcard');
        const prevBtn = modalContent.querySelector('#prev-card');
        const nextBtn = modalContent.querySelector('#next-card');
        const shuffleBtn = modalContent.querySelector('#shuffle-cards');
        const flipBtn = modalContent.querySelector('#flip-card');
        const frontEl = modalContent.querySelector('.front');
        const backEl = modalContent.querySelector('.back');

        const updateCardUI = () => {
            const card = cards[index];
            frontEl.innerHTML = card.term || '';
            backEl.innerHTML = card.definition || '';
            flashcardEl.classList.remove('is-flipped');
            renderMath(modalContent); // render LaTeX in the modal
        };

        prevBtn.onclick = () => { index = (index - 1 + cards.length) % cards.length; updateCardUI(); };
        nextBtn.onclick = () => { index = (index + 1) % cards.length; updateCardUI(); };
        shuffleBtn.onclick = () => {
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            index = 0;
            updateCardUI();
        };
        const toggleFlip = () => flashcardEl.classList.toggle('is-flipped');
        flipBtn.onclick = toggleFlip;
        flashcardEl.onclick = toggleFlip;

        // ensure math renders for initial card
        renderMath(modalContent);
    }, 0);
}

            function handleShowSettings() { /* Unchanged */ }

            function handleThemeSettings() {
                const themes = [
                    { id: 'cute-pink', name: 'Cute Pink' },
                    { id: 'ocean-blue', name: 'Ocean Blue' },
                    { id: 'forest-green', name: 'Forest Green' }
                ];
                showModal(`
                    <h3 class="text-xl font-bold mb-4">Settings</h3>
                    <div class="space-y-2">
                        <p class="font-semibold text-gray-700">Theme</p>
                        ${themes.map(theme => `
                            <label class="flex items-center justify-between p-3 bg-gray-100 rounded-lg cursor-pointer">
                                <span>${theme.name}</span>
                                <input type="radio" name="theme" value="${theme.id}" ${studyData.settings.theme === theme.id ? 'checked' : ''}>
                            </label>
                        `).join('')}
                    </div>
                    <div class="mt-6 pt-4 border-t">
                        <p class="font-semibold text-gray-700">Data Management</p>
                        <button id="reset-data-btn" class="w-full cute-btn btn-danger mt-2">Reset All Data</button>
                        <p class="text-xs text-gray-500 mt-1">This will permanently delete all your classes and content.</p>
                    </div>
                `);
                document.querySelectorAll('input[name="theme"]').forEach(radio => {
                    radio.onchange = (e) => {
                        studyData.settings.theme = e.target.value;
                        applyTheme();
                        saveData();
                    };
                });
                document.getElementById('reset-data-btn').onclick = () => {
                    if (confirm('Are you absolutely sure you want to delete ALL data? This cannot be undone.')) {
                        localStorage.removeItem('studyGuideData');
                        location.reload();
                    }
                };
            }

            function handleExportPdf() {
    const container = document.getElementById('page-content-container');
    if (!container) {
        alert('Nothing to export right now.');
        return;
    }

    // Clone the content so we don't disturb the live DOM
    const clone = container.cloneNode(true);
    clone.style.position = 'fixed';
    clone.style.left = '-9999px';
    clone.style.top = '0';
    document.body.appendChild(clone);

    // Render math in the clone (uses your helper)
    renderMath(clone);

    const filenameBase = (getCurrentContent() && getCurrentContent().name) ? getCurrentContent().name.replace(/\s+/g, '_') : 'study_guide';
    const opt = {
        margin: 10,
        filename: `${filenameBase}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(clone).set(opt).save()
        .then(() => clone.remove())
        .catch(err => { clone.remove(); alert('PDF export failed: ' + err); });
}


            // --- INITIALIZATION ---
            function init() {
                loadData();
                applyTheme();
                navigate('folders');
            }

            init();
        });
    </script>
</body>
</html>
